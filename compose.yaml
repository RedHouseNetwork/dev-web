services:
  caddy:
    container_name: caddy
    image: caddy:2-alpine
    ports:
      - "80:80"
      - "443:443"
    environment:
      WEB_ROOT: ${WEB_ROOT}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - ./certs:/etc/caddy/certs:ro
      - ./overrides:/etc/caddy/overrides:ro
      - web:${WEB_ROOT}:ro
    depends_on:
      - php83
      - php84
    restart: unless-stopped

  php83:
    container_name: php83
    build:
      context: .
      dockerfile: Dockerfile.php
      args:
        PHP_VERSION: "8.3"
        WEB_ROOT: ${WEB_ROOT}
        HOST_UID: ${UID}
        SQLCIPHER_VERSION: ${PHP83_SQLCIPHER_VERSION:-}
        CHROME_VERSION: ${PHP83_CHROME_VERSION:-128.0.6613.137}
        INSTALL_XDEBUG: ${PHP83_XDEBUG:-}
    hostname: PHP83
    user: "${UID}:${UID}"
    shm_size: '2g'
    tmpfs:
      - /tmp
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    environment:
      PANTHER_NO_SANDBOX: 1
      HOME: /home/dev
      CLAUDE_AUTO_UPDATE: 0
    volumes:
      - web:${WEB_ROOT}
      - ./config/php.ini:/usr/local/etc/php/conf.d/zzz-custom.ini:ro
      - ./config/php83-overrides.ini:/usr/local/etc/php/conf.d/zzzz-overrides.ini:ro
      - ./config/php-fpm-pool.conf:/usr/local/etc/php-fpm.d/zzz-custom.conf:ro
      - ${HOME}/.local/bin/claude:/usr/local/bin/claude:ro
      - ${HOME}/.claude/.credentials.json:/home/dev/.claude/.credentials.json:ro
      - ${HOME}/.claude.json:/home/dev/.claude.json
    restart: unless-stopped

  php84:
    container_name: php84
    build:
      context: .
      dockerfile: Dockerfile.php
      args:
        PHP_VERSION: "8.4"
        WEB_ROOT: ${WEB_ROOT}
        HOST_UID: ${UID}
        SQLCIPHER_VERSION: ${PHP84_SQLCIPHER_VERSION:-}
        CHROME_VERSION: ${PHP84_CHROME_VERSION:-128.0.6613.137}
        INSTALL_XDEBUG: ${PHP84_XDEBUG:-}
    hostname: PHP84
    user: "${UID}:${UID}"
    shm_size: '2g'
    tmpfs:
      - /tmp
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    environment:
      PANTHER_NO_SANDBOX: 1
      HOME: /home/dev
      CLAUDE_AUTO_UPDATE: 0
    volumes:
      - web:${WEB_ROOT}
      - ./config/php.ini:/usr/local/etc/php/conf.d/zzz-custom.ini:ro
      - ./config/php84-overrides.ini:/usr/local/etc/php/conf.d/zzzz-overrides.ini:ro
      - ./config/php-fpm-pool.conf:/usr/local/etc/php-fpm.d/zzz-custom.conf:ro
      - ${HOME}/.local/bin/claude:/usr/local/bin/claude:ro
      - ${HOME}/.claude/.credentials.json:/home/dev/.claude/.credentials.json:ro
      - ${HOME}/.claude.json:/home/dev/.claude.json
    restart: unless-stopped

  mysql:
    container_name: mysql
    image: mysql:8.0
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_PASSWORD}
      LANG: C.UTF-8
      LC_ALL: C.UTF-8
    ports:
      - "3306:3306"
    volumes:
      - ./data/mysql:/var/lib/mysql
      - ./config/my.cnf:/etc/my.cnf:ro
      - ./data/dumps:/dumps
      - web:/web

  mysql84:
    container_name: mysql84
    image: mysql:8.4
    profiles: [mysql84]
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_PASSWORD}
    ports:
      - "3384:3306"
    volumes:
      - ./data/mysql84:/var/lib/mysql
      - ./data/dumps:/dumps
      - web:/web

  mariadb:
    container_name: mariadb
    image: mariadb:11.1
    profiles: [mariadb]
    restart: unless-stopped
    environment:
      MARIADB_ROOT_PASSWORD: ${MYSQL_PASSWORD}
    ports:
      - "3406:3306"
    volumes:
      - ./data/mariadb:/var/lib/mysql
      - ./data/dumps:/dumps
      - web:/web

  # N.B. mkdir data/mssql && sudo chown 10001:0 data/mssql
  mssql:
    container_name: mssql
    image: mcr.microsoft.com/mssql/server:2022-latest
    profiles: [mssql]
    restart: unless-stopped
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: ${MSSQL_PASSWORD}
      MSSQL_PID: Developer
    ports:
      - "1433:1433"
    volumes:
      - ./data/mssql:/var/opt/mssql

  postgres:
    container_name: postgres
    image: postgres
    profiles: [postgres]
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "5432:5432"
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - web:/web

volumes:
  web:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${WEB_ROOT}
